{% extends 'base.html' %}

{% block title %}Price Page{% endblock %}

{% block content %}
<img id="logo" src="/static/images/logo_osol.png" alt="Logo">
<div id="price-container">
    <div class="price-block">
        <span class="label">Price:</span>
        <span id="price" class="small-text">Loading...</span>
        <span id="change">Loading</span>
    </div>
    <div class="price-block">
        <span id="marketcap" class="small-text">Loading</span>
    </div>
    <div id="countdown-container">
        <div id="countdown">âˆž:âˆž:âˆž:âˆž</div>
    </div>
</div>
<div id="powered">powered by SuperMissO</div>
{% endblock %}

{% block scripts %}
<style>
    #logo {
        width: 8vw;
        margin-bottom: 2vw;
        margin-top: -10vw;
    }

    .label {
        font-size: 1.5vw;
        font-weight: bold;
        color: #aaa;
        margin-right: 2vw;
    }

    #price-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        text-align: center;
    }

    .price-block {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        color: #47d7ac;
    }

    #powered {
        margin-top: 5px;
        font-size: 0.8vw;
        color: #aaa;
        text-align: center;
        font-family: "Neue Machina", Arial, sans-serif;
    }

    .small-text {
        font-size: 3vw;
    }

    .large-text {
        font-size: 5vw; 
    }

    #change {
        font-size: 1vw;
        color: #aaa;
        align-self: center;
        margin-left: 3vw;
    }


    #countdown-container {
        margin-top: 2vw;
    }

    #countdown {
        font-size: 6vw; 
        font-weight: bold;
        color: #ffffff;
    }

    @media (max-width: 768px) {
        .label {
            font-size: 3vw;
        }

        #logo {
            width: 15vw;
        }

        .small-text {
            font-size: 6vw;
        }

        .large-text {
            font-size: 10vw;
        }

        #change {
            font-size: 3vw;
            margin-top: 1vw;
            margin-bottom: 3vw;
        }

        #powered {
            font-size: 2.5vw;
        }

        #countdown {
            font-size: 10vw;
        }
    }

    @media (max-width: 480px) {
        .small-text {
            font-size: 8vw;
        }

        .large-text {
            font-size: 12vw;
        }

        #change {
            font-size: 1.5vw;
            margin-top: 1vw;
            margin-bottom: 3vw;
        }

        #powered {
            font-size: 2.5vw;
        }

        #countdown {
            font-size: 12vw;
        }
    }
</style>

<script>
    let previousPrice = 0;

    function formatMarketCap(marketCap) {
        if (marketCap >= 1_000_000_000) {
            return (marketCap / 1_000_000_000).toFixed(1) + 'B'; 
        } else if (marketCap >= 1_000_000) {
            return (marketCap / 1_000_000).toFixed(1) + 'M'; 
        } else if (marketCap >= 1_000) {
            return (marketCap / 1_000).toFixed(1) + 'K'; 
        } else {
            return marketCap.toString(); 
        }
    }

    async function fetchPrice() {
        
        const priceElement = document.getElementById("price");
        const marketCapElement = document.getElementById("marketcap");
        const changeElement = document.getElementById("change");
        marketCapElement.style.color = "white";


        try {
            const response = await fetch("/price");
            if (!response.ok) throw new Error("Network response was not ok");

            const data = await response.json();
            const currentPrice = parseFloat(data.osolCurrentPrice).toFixed(6);
            if (isNaN(currentPrice)) {
                priceElement.textContent = "Waiting for the launch";
                marketCapElement.textContent = "Waiting for the launch";
                return;
            }

            const marketCap = parseFloat(data.osolMarketCap);
            const change24h = parseFloat(data.osolPriceChange);

            priceElement.textContent = currentPrice.replace('.', ',');
            //marketCapElement.textContent = marketCap.toLocaleString();
            marketCapElement.textContent = formatMarketCap(marketCap); 

            if (currentPrice > previousPrice) {
                priceElement.style.color = "#47d7ac";
            } else if (currentPrice < previousPrice) {
                priceElement.style.color = "#d94848";
            }

            let emoji = "";
            if (change24h > 200) {
                emoji = "ðŸš€ðŸš€ðŸš€";
            } else if (change24h > 100) {
                emoji = "ðŸš€ðŸš€";
            } else if (change24h > 50) {
                emoji = "ðŸš€";
            }
            changeElement.textContent = `${change24h.toFixed(2)}% ${emoji}`;
            changeElement.style.color = change24h > 0 ? "#47d7ac" : "#ff4c4c";

            previousPrice = currentPrice;
        } catch (error) {
            console.error("Error fetching price:", error);
        }
    }

    function startCountdown(targetDate) {
        const countdownElement = document.getElementById("countdown");
        const countdownContainer = document.getElementById("countdown-container");
        const priceElement = document.getElementById("price");
        const marketCapElement = document.getElementById("marketcap");

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance <= 0) {
                countdownElement.textContent = "00:00:00:00";
                clearInterval(countdownInterval);

                countdownContainer.style.display = "none";
                priceElement.classList.remove("small-text");
                priceElement.classList.add("large-text");
                marketCapElement.classList.remove("small-text");
                marketCapElement.classList.add("large-text");
            } else {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.textContent = `${String(days).padStart(2, "0")}:${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
            }
        }

        const countdownInterval = setInterval(updateCountdown, 1000);
        updateCountdown();
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetchPrice();
        setInterval(fetchPrice, 2000);

        const countdownTarget = new Date("2024-12-23T16:00:00Z").getTime();
        startCountdown(countdownTarget);
    });
</script>

{% endblock %}
